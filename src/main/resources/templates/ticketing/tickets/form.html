<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create New Ticket - EZBus Ticketing</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/index/style.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/css/ticketing.css}">
    <script src="https://cdn.jsdelivr.net/gh/Saviru/GlassiFy@1.0.0/glassify.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <header class="header glassify">
        <nav class="navbar">
            <div class="nav-container">
                <div class="nav-logo navAnim">
                    <i class="fas fa-ticket-alt"></i>
                    <span>EZBus Ticketing</span>
                </div>
                <ul class="nav-menu">
                    <li class="nav-item navAnim">
                        <a href="/ticketing" class="nav-link">Dashboard</a>
                    </li>
                    <li class="nav-item navAnim">
                        <a href="/ticketing/tickets" class="nav-link active">Tickets</a>
                    </li>
                    <li class="nav-item navAnim">
                        <a href="/ticketing/fares" class="nav-link">Fares</a>
                    </li>
                </ul>
                <div class="nav-auth navAnim3">
                    <button class="theme-toggle glassify" id="themeToggle" aria-label="Toggle theme">
                        <i class="fas fa-moon" id="themeIcon"></i>
                    </button>
                    <a href="/" class="btn-login glassify navAnim">Home</a>
                    <a href="/logout" class="btn-register glassify navAnim">Logout</a>
                </div>
                <div class="hamburger">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </div>
            </div>
        </nav>
    </header>

    <section class="hero" style="min-height: 25vh; padding: 120px 20px 40px;">
        <div class="hero-content">
            <div class="hero-text">
                <h1><span class="gradient-h1">Create New Ticket</span></h1>
                <p>Issue ticket for passenger</p>
            </div>
        </div>
    </section>

    <section class="features" style="padding: 40px 20px 80px;">
        <div class="container">
            <div class="form-container glassify">
                <!-- Alert Messages -->
                <div th:if="${errorMessage}" class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i>
                    <span th:text="${errorMessage}"></span>
                </div>

                <form th:action="@{/ticketing/tickets}" method="post" id="ticketForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="passengerId">
                                <i class="fas fa-user"></i> Select Passenger *
                            </label>
                            <select id="passengerId" name="passengerId" required>
                                <option value="">Choose passenger...</option>
                                <option th:each="passenger : ${passengers}"
                                        th:value="${passenger.id}"
                                        th:text="${passenger.firstName + ' ' + passenger.lastName + ' (' + passenger.email + ')'}">
                                </option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="routeId">
                                <i class="fas fa-route"></i> Select Route *
                            </label>
                            <select id="routeId" name="routeId" required>
                                <option value="">Choose route...</option>
                                <option th:each="route : ${routes}"
                                        th:value="${route.id}"
                                        th:text="${route.origin + ' â†’ ' + route.destination}">
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="scheduleId">
                                <i class="fas fa-clock"></i> Select Schedule *
                            </label>
                            <select id="scheduleId" name="scheduleId" required>
                                <option value="">Choose schedule...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ticketType">
                                <i class="fas fa-tags"></i> Ticket Type *
                            </label>
                            <select id="ticketType" name="ticketType" required>
                                <option value="">Choose ticket type...</option>
                                <option value="REGULAR">Regular</option>
                                <option value="STUDENT">Student</option>
                                <option value="SENIOR">Senior</option>
                                <option value="CHILD">Child</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="travelDate">
                                <i class="fas fa-calendar"></i> Travel Date *
                            </label>
                            <input type="date" id="travelDate" name="travelDate" required>
                        </div>
                        <div class="form-group">
                            <label for="seatNumber">
                                <i class="fas fa-chair"></i> Available Seats *
                            </label>
                            <select id="seatNumber" name="seatNumber" required disabled>
                                <option value="">Select route, schedule and date first...</option>
                            </select>
                            <small style="color: var(--text-secondary); display: block; margin-top: 5px;">
                                <span id="seatStatus">Please select route, schedule and travel date to see available seats</span>
                            </small>
                        </div>
                    </div>

                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="specialRequests">
                            <i class="fas fa-comment"></i> Special Requests
                        </label>
                        <textarea id="specialRequests" name="specialRequests" rows="3"
                                  placeholder="Any special requests or notes for this ticket..."></textarea>
                    </div>

                    <!-- Fare Information Display -->
                    <div id="fareInfo" class="alert alert-info" style="display: none;">
                        <h6><i class="fas fa-dollar-sign"></i> Fare Information</h6>
                        <p style="margin-bottom: 5px;">Base Fare: $<span id="baseFare">0.00</span></p>
                        <p style="margin-bottom: 5px;">Discount: $<span id="discount">0.00</span></p>
                        <p style="margin-bottom: 0;"><strong>Final Amount: $<span id="finalAmount">0.00</span></strong></p>
                    </div>

                    <div class="form-actions">
                        <a href="/ticketing/tickets" class="btn-secondary glassify">
                            <i class="fas fa-arrow-left"></i> Back to Tickets
                        </a>
                        <button type="submit" class="btn-primary glassify">
                            <i class="fas fa-save"></i> Create Ticket
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="footer-logo">
                        <i class="fas fa-bus"></i>
                        <span>EZBus</span>
                    </div>
                    <p>Your Smart Travel Companion</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 EZBus. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <glassi-fy octaves="100"></glassi-fy>
    <script th:src="@{/css/index/script.js}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const routeSelect = document.getElementById('routeId');
            const scheduleSelect = document.getElementById('scheduleId');
            const ticketTypeSelect = document.getElementById('ticketType');
            const travelDateInput = document.getElementById('travelDate');
            const seatSelect = document.getElementById('seatNumber');
            const fareInfo = document.getElementById('fareInfo');

            // Load schedules when route changes
            routeSelect.addEventListener('change', function() {
                const routeId = this.value;
                scheduleSelect.innerHTML = '<option value="">Choose schedule...</option>';
                seatSelect.innerHTML = '<option value="">Choose seat...</option>';
                fareInfo.style.display = 'none';

                if (routeId) {
                    fetch(`/ticketing/routes/${routeId}/schedules`)
                        .then(response => response.json())
                        .then(schedules => {
                            schedules.forEach(schedule => {
                                const option = document.createElement('option');
                                option.value = schedule.id;
                                option.textContent = `${schedule.departureTime} - ${schedule.arrivalTime}`;
                                scheduleSelect.appendChild(option);
                            });
                        })
                        .catch(error => console.error('Error loading schedules:', error));

                    // Load fare information
                    loadFareInfo();
                }
            });

            // Load available seats when schedule, date change
            function loadAvailableSeats() {
                const scheduleId = scheduleSelect.value;
                const travelDate = travelDateInput.value;
                const seatStatus = document.getElementById('seatStatus');

                if (scheduleId && travelDate) {
                    seatSelect.disabled = true;
                    seatStatus.textContent = 'Loading available seats...';
                    seatStatus.style.color = '#2196F3';

                    fetch(`/ticketing/schedules/${scheduleId}/booked-seats?travelDate=${travelDate}`)
                        .then(response => response.json())
                        .then(bookedSeats => {
                            seatSelect.innerHTML = '<option value="">Choose available seat...</option>';

                            let availableSeats = 0;
                            // Generate seat options (assuming seats 1-40 for simplicity)
                            for (let i = 1; i <= 40; i++) {
                                const seatNumber = i.toString().padStart(2, '0');
                                if (!bookedSeats.includes(seatNumber)) {
                                    const option = document.createElement('option');
                                    option.value = seatNumber;
                                    option.textContent = `Seat ${seatNumber}`;
                                    seatSelect.appendChild(option);
                                    availableSeats++;
                                }
                            }

                            seatSelect.disabled = false;
                            if (availableSeats > 0) {
                                seatStatus.textContent = `${availableSeats} seats available`;
                                seatStatus.style.color = '#4CAF50';
                            } else {
                                seatStatus.textContent = 'No seats available for this schedule and date';
                                seatStatus.style.color = '#f44336';
                                seatSelect.disabled = true;
                            }
                        })
                        .catch(error => {
                            console.error('Error loading seats:', error);
                            seatStatus.textContent = 'Error loading seats. Please try again.';
                            seatStatus.style.color = '#f44336';
                            seatSelect.disabled = true;
                        });
                } else {
                    seatSelect.innerHTML = '<option value="">Select route, schedule and date first...</option>';
                    seatSelect.disabled = true;
                    seatStatus.textContent = 'Please select route, schedule and travel date to see available seats';
                    seatStatus.style.color = 'var(--text-secondary)';
                }
            }

            scheduleSelect.addEventListener('change', loadAvailableSeats);
            travelDateInput.addEventListener('change', loadAvailableSeats);

            // Load fare information
            function loadFareInfo() {
                const routeId = routeSelect.value;
                const ticketType = ticketTypeSelect.value;

                if (routeId && ticketType) {
                    fetch(`/ticketing/routes/${routeId}/fares`)
                        .then(response => response.json())
                        .then(fares => {
                            const fare = fares.find(f => f.ticketType === ticketType);
                            if (fare) {
                                const baseFare = fare.basePrice;
                                const discount = baseFare * (fare.discountPercentage / 100);
                                const finalAmount = baseFare - discount;

                                document.getElementById('baseFare').textContent = baseFare.toFixed(2);
                                document.getElementById('discount').textContent = discount.toFixed(2);
                                document.getElementById('finalAmount').textContent = finalAmount.toFixed(2);
                                fareInfo.style.display = 'block';
                            }
                        })
                        .catch(error => console.error('Error loading fare info:', error));
                }
            }

            ticketTypeSelect.addEventListener('change', loadFareInfo);

            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            travelDateInput.setAttribute('min', today);
        });
    </script>
</body>
</html>

